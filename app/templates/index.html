{% extends "base.html" %}

{% block content %}
<div id="map" style="height: 600px;"></div> <!-- Div per la mappa -->

<!-- Barra di scorrimento per selezionare l'anno -->
<div style="text-align: center; margin-top: 10px;">
    <label for="yearSlider">Seleziona un anno: </label>
    <input type="range" id="yearSlider" min="2022" max="2024" step="1" value="2022">
    <span id="selectedYear">2022</span>
</div>

<script>
    // Inizializza la mappa
    var map = L.map('map').setView([51.505, -0.09], 5);

    // Aggiungi i tile alla mappa
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
    }).addTo(map);

    // Dati degli eventi
    var eventData = {{ event_data|tojson }};
    
    // Scala dei colori in base alla gravità
    var colorScale = {
        1: '#ffcccc',
        2: '#ff9999',
        3: '#ff6666',
        4: '#ff3333',
        5: '#ff0000'
    };

    // Mantenere una lista di cerchi per rimuoverli al cambio di anno
    var eventCircles = [];

    // Funzione per aggiornare la mappa in base all'anno selezionato
    function updateMap(selectedYear) {
        // Rimuovi tutti i cerchi dalla mappa
        eventCircles.forEach(function(circle) {
            map.removeLayer(circle);
        });
        eventCircles = [];

        // Filtra gli eventi in base all'anno selezionato
        var filteredEvents = eventData.filter(function(event) {
            var eventYear = new Date(event.data_inizio).getFullYear();
            return eventYear === selectedYear;
        });

        // Aggiungi i cerchi per gli eventi filtrati
        filteredEvents.forEach(function(event) {
            var coordinate = [event.latitudine, event.longitudine];
            var fillColor = colorScale[event.severity];
            var radius = event.severity * 1000;

            var cerchio = L.circle(coordinate, {
                color: 'red',
                fillColor: fillColor,
                fillOpacity: 0.5,
                radius: radius
            }).addTo(map);

            // Aggiungi un tooltip con le informazioni
            cerchio.bindTooltip(`
                <strong>Luogo:</strong> ${event.luogo} <br>
                <strong>Evento:</strong> ${event.evento} <br>
                <strong>Severità:</strong> ${event.severity}
            `, {
                permanent: false,
                direction: "top"
            });

            // Aggiungi il cerchio alla lista per gestire il reset
            eventCircles.push(cerchio);
        });
    }

    // Gestisci il cambiamento della data tramite lo slider
    var yearSlider = document.getElementById('yearSlider');
    var selectedYearLabel = document.getElementById('selectedYear');

    yearSlider.addEventListener('input', function() {
        var selectedYear = parseInt(yearSlider.value);
        selectedYearLabel.innerText = selectedYear;
        updateMap(selectedYear);
    });

    // Inizializza la mappa con l'anno di default
    updateMap(parseInt(yearSlider.value));
</script>
{% endblock %}
