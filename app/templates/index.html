{% extends "base.html" %}

{% block content %}
<div id="map" style="height: 600px;"></div> <!-- Div per la mappa -->

<!-- Barra di scorrimento per selezionare l'anno -->
<!-- Barra di scorrimento per selezionare l'anno -->
<div style="text-align: center; margin-top: 10px;">
    <label for="yearSlider">Seleziona un anno: </label>
    <input type="range" id="yearSlider" min="1900" max="2050" step="1" value="2024">
    <span id="selectedYear">2024</span>
    <button id="downloadBtn" style="margin-left: 10px; background-color: #FF0000; color: white; border: none; border-radius: 5px; padding: 10px 15px; cursor: pointer;">Scarica CSV</button>
</div>


<script>
    // Inizializza la mappa
    var map = L.map('map').setView([51.505, -0.09], 5);

    // Aggiungi i tile alla mappa
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
    }).addTo(map);

    // Dati degli eventi
    var eventData = {{ event_data|tojson }};

    // Scala dei colori e dimensioni in base alla severit√†
    var colorScale = {
        1: '#FFD700', // Giallo per severity 1
        2: '#FFA500', // Arancione per severity 2
        3: '#FF8C00', // Arancione scuro per severity 3
        4: '#FF4500', // Rosso aranciato per severity 4
        5: '#FF0000'  // Rosso per severity 5
    };

    // Mantenere una lista di cerchi per rimuoverli al cambio di anno
    var eventCircles = [];

    // Funzione per aggiornare la mappa in base all'anno selezionato
    function updateMap(selectedYear) {
        // Rimuovi tutti i cerchi dalla mappa
        eventCircles.forEach(function(circle) {
            map.removeLayer(circle);
        });
        eventCircles = [];

        // Filtra gli eventi in base all'anno selezionato
        var filteredEvents = eventData.filter(function(event) {
            var eventYear = new Date(event.data_inizio).getFullYear();
            return eventYear === selectedYear;
        });

        // Aggiungi i cerchi per gli eventi filtrati
        filteredEvents.forEach(function(event) {
            var coordinate = [event.latitudine, event.longitudine];
            var fillColor = colorScale[event.severity];
            var radius = event.severity * 50000;

            var cerchio = L.circle(coordinate, {
                color: 'red',
                fillColor: fillColor,
                fillOpacity: 0.5,
                radius: radius
            }).addTo(map);

            // Aggiungi un tooltip con le informazioni
            cerchio.bindTooltip(`
                <strong>Location:</strong> ${event.luogo} <br>
                <strong>Event:</strong> ${event.evento} <br>
                <strong>Severity:</strong> ${event.severity}
            `, {
                permanent: false,
                direction: "top"
            });

            // Aggiungi il cerchio alla lista per gestire il reset
            eventCircles.push(cerchio);
        });
    }

    // Gestisci il cambiamento della data tramite lo slider
    var yearSlider = document.getElementById('yearSlider');
    var selectedYearLabel = document.getElementById('selectedYear');

    yearSlider.addEventListener('input', function() {
        var selectedYear = parseInt(yearSlider.value);
        selectedYearLabel.innerText = selectedYear;
        updateMap(selectedYear);
    });

    // Inizializza la mappa con l'anno di default
    updateMap(parseInt(yearSlider.value));

    // Funzione per scaricare i dati in formato CSV
    function downloadCSV(selectedYear) {
        // Filtra gli eventi in base all'anno selezionato
        var filteredEvents = eventData.filter(function(event) {
            var eventYear = new Date(event.data_inizio).getFullYear();
            return eventYear === selectedYear;
        });

        // Crea il contenuto CSV
        var csvContent = "data:text/csv;charset=utf-8," 
            + "id,luogo,evento,data_inizio,data_fine,severity,longitudine,latitudine\n"
            + filteredEvents.map(event => [
                event.id, event.luogo, event.evento, event.data_inizio,
                event.data_fine, event.severity, event.longitudine, event.latitudine
            ].join(",")).join("\n");

        // Crea un link per il download
        var encodedUri = encodeURI(csvContent);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `eventi_${selectedYear}.csv`);
        document.body.appendChild(link); // necessario per Firefox

        link.click(); // simula il click per scaricare il file
        document.body.removeChild(link); // rimuovi il link dopo il download
    }

    // Gestisci il click sul bottone di download
    var downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.addEventListener('click', function() {
        var selectedYear = parseInt(yearSlider.value);
        downloadCSV(selectedYear);
    });
</script>
{% endblock %}
